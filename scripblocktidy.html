<!DOCTYPE html>
<html>
<head>
<base href="https://www.weedtree.fyi">

<script src="https://cdn.counter.dev/script.js" data-id="c89e409b-c7ae-4e59-8da1-bf5116b65993" data-utcoffset="13"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8527SLLPYV"></script>
<script>
    window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8527SLLPYV');
</script>

<title>WeedTree Strain Lineage Chart</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" xhref='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 850"><path fill="%2391C83E" d="M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/><path fill="%236FAC43" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7z"/><path fill="none" stroke="%23444" stroke-width="79.2" stroke-linejoin="round" stroke-miterlimit="8" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7zm-44.8 237.5c137.8 80.2 275.3 80.2 412.7 0M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/></svg>' />

<style>
body,html{font-family:'Poppins',Arial,sans-serif;background-color:#fff;margin:0;padding:0;font-size:14px;height:100%;overflow:hidden}.header-ribbon{background-color:#434343;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}.header-ribbon h1{margin:0;font-size:1.8em;color:#fff;margin-left:6px}.subhead{font-size:.4em;font-weight:400;margin-left:3px}.container{height:calc(100vh - 50px);display:flex;flex-direction:column}.chart-container{flex-grow:1;width:100%;overflow:hidden}#lineageChart{width:100%;height:100%}.header-buttons{display:flex;gap:10px;align-items:center}.btn{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;cursor:pointer;font-size:0.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.btn:hover{background-color:rgba(255,255,255,.1)}.node text{font-size:16px;fill:black;text-anchor:start;dominant-baseline:middle;font-family:'Roboto',Arial,sans-serif;font-weight:700}.node text.product{font-size:10px;font-weight:normal;}.node.dimmed rect{opacity:.15}.node.dimmed text{opacity:.15}.node.dimmed use{opacity:.15}.link.dimmed{opacity:.15}.node.highlighted rect{stroke:#f0f;stroke-width:3px}.link.highlighted{stroke:#f0f!important;stroke-width:3px}.node.clicked rect{stroke:#f0f;stroke-width:8px}.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;max-width:80%;max-height:80%;overflow-y:auto;z-index:1000;display:none;}.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:999;display:none}#loading-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(255,255,255,0.8);padding:20px;border-radius:10px;z-index:1001;display:none}#strainSearch{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;font-size:.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;width:180px}#strainSearch::placeholder{color:rgba(255,255,255,0.7)}#strainSearch:focus{outline:none;background-color:rgba(255,255,255,0.1)}#strainDropdown{position:absolute;background-color:#fff;border:1px solid #ccc;max-height:400px;overflow-y:auto;display:none;z-index:1000;width:210px;box-shadow:1 4px 8px rgba(0,0,0,0.1);border-radius:0 0 4px 4px}#strainDropdown div{padding:5px 10px;cursor:pointer;transition:background-color 0.2s;color:#434343;font-size:8pt;line-height:1.2}#strainDropdown div:hover{background-color:#f0f0f0}.search-container{position:relative}.node.highlighted-search .highlight-arrow{fill:red}#centerLine {position: fixed;top: 0;left: 0;width: 100%;height: 100%;pointer-events: none;}.fullscreen-button-container {display: flex;flex-direction: column;gap: 5px;position: absolute;top: 70px;right: 10px;z-index: 997;}.zoom-button-container {display: flex;width: 100%;gap: 5px;}.fullscreen-button-container button {width: 100%;padding: 3px 5px;border: 2px solid #cccccc;border-radius: 0;cursor: pointer;font-size: 0.3em;font-family: 'Poppins', Arial, sans-serif;transition: all 0.3s ease;color: #cccccc;background-color: white;}.node{transition: transform 0.0s ease;}.strain-list {column-width: 228px;column-gap: 5px;padding: 10px;max-height: 96%;overflow-x: auto;white-space: nowrap;}.strain-item {display: flex;align-items: center;margin-bottom: 0px;break-inside: avoid-column;}.strain-checkbox {appearance: none;-webkit-appearance: none;width: 16px;height: 16px;border: 2px solid #434343;border-radius: 50%;margin-right: 5px;cursor: pointer;position: relative;}.strain-checkbox:checked::after {content: '';position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);width: 10px;height: 10px;background-color:#434343;border-radius:50%;}.strain-checkbox:hover {background-color: #f0f0f0;}.strain-label {font-size: 8pt;cursor: pointer;}#popup1 {padding: 0;}#popup2, #popup3 {padding: 20px;}.node use {z-index: 1000; pointer-events: none;} .node text {z-index: 999;}#zoomInButton, #zoomOutButton {flex: 1;padding: 0px 5px;font-size: 16px;font-weight: bold;}#zoomInButton {border-right: 2px solid #cccccc; border-top-right-radius: 0;border-bottom-right-radius: 0;}#zoomOutButton {border-left: 2px solid #cccccc; border-top-left-radius: 0;border-bottom-left-radius: 0;}.close-button {position: absolute;top: 10px;right: 10px;width: 30px;height: 30px;border:none;background:#434343;color:white;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color 0.3s;}.close-button:hover {background-color:#666;}.pct-pill {fill: #000;stroke: #000;stroke-width: 0px;}.pct-pill-text {fill: #fff;font-size: 9px;  font-weight: 700;pointer-events: none;}
</style>

<script src="https://d3js.org/d3.v6.min.js"></script>
  
</head>
  
<body>
  
<div class="header-ribbon">
    <h1>WeedTree.fyi Strain Lineage Chart <span class="subhead">Work in progress, errors probable</span></h1>
    <div class="header-buttons">
        <div class="search-container">
            <input type="text" id="strainSearch" placeholder="Locate strain">
            <div id="strainDropdown"></div>
        </div>
        
        <button id="btn3" class="btn">About</button>
    </div>
</div>
<div class="fullscreen-button-container">
    <button id="fullscreenToggle" class="btn">Toggle Full Screen</button>
    <div class="zoom-button-container">
        <button id="zoomInButton" class="btn">+</button>
        <button id="zoomOutButton" class="btn">-</button>
    </div>
    <button id="deselectButton" class="btn">De-select</button>
</div>
<div class="container">
    <div class="chart-container">
        <div id="lineageChart"></div>
    </div>
</div>
<div class="popup-overlay"></div>
<div id="popup1" class="popup">
    <div id="strainList" class="strain-list"></div>
</div>
<div id="popup2" class="popup"><h5>Record and rate your strains - coming soon</h5></div>
<div id="popup3" class="popup">
    <button class="close-button">Ã—</button>
    
<h2>Welcome to Weedtree, the family tree of cannabis strains</h2>
    
<p>I've always wondered how strain lineage correlated with the strains I personally prefer. Indica vs Sativa, Kush vs Afghani, Skunk vs Thai. I haven't been able to find much of a lineage chart anywhere online so decided to create one myself. </p>
    
<p>I don't claim that the chart is completely accurate, it is based on what I could interpret from the multitude of, often contradictory, strain database sites internationally, and I've made some simplifications around phenotype/cultivar/clone/variant pedigree. Obviously it is far from complete.</p>
    
<p></br>Push F11 to toggle full screen.
</br>Use the mouse or controls to zoom in and out.
</br> Nodes are draggable within their column (press shift / long press on mobile).
</br> Click on a strain to isolate its lineage.</p>
    
<p>Isolation mode shows rough percentage of contribution based on lineage, but will be inaccurate as it does not account for the realities and nuances of selective breeding.</p>

<p>Sorry it's a bit hard to use on mobile, best on a large screen. Strain search isn't working on mobile at the moment either.</p>

</div>
<div id="loading-message">Loading strain data, please wait...</div>
<div id="centerLine"></div>

  <svg id="nzIconTemplate" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="display: none;">
  <symbol id="nzIcon">
    <circle cx="14" cy="14" r="12.5" fill="white" stroke="black" stroke-width="3"/>
    <line x1="7" y1="9" x2="7" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="7" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="13" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="9" x2="20.5" y2="9" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="19" x2="21.5" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="21.5" y1="9" x2="16" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
  </symbol>
</svg>

  
<script>
/* ================== GLOBAL VARIABLES ================== */
let strainData = [], attributes = [], nodes = [], links = [];
let svg, g, zoom;
let focusedNode = null;
let dragging = false;
const lineWidth = 2;

// Node visual constants
const nodePillHeight = 30;
const nodeStrokeWidth = 3;
const nodeStrokeColor = "#000";
const nodeTextYOffset = 1;


/* ================== HELPER FUNCTIONS ================== */
function showError(message) {
    document.getElementById("loading-message").style.display = "none";
    alert(message);
}

function formatPercentage(p) {
    return p < 5 ? "<5%" : `${p.toFixed(0)}%`;
}

function darkenColor(color, percent) {
    const f = parseInt(color.slice(1),16), t=percent<0?0:255,p=Math.abs(percent)/100,
          R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
    return "#" + (0x1000000 + 
        (Math.round((t-R)*p)+R)*0x10000 + 
        (Math.round((t-G)*p)+G)*0x100 + 
        (Math.round((t-B)*p)+B)).toString(16).slice(1);
}

function blendToWhite(color, ratio) {
    const r = parseInt(color.substr(1,2),16);
    const g = parseInt(color.substr(3,2),16);
    const b = parseInt(color.substr(5,2),16);
    const newR = Math.round(r + (255 - r) * ratio);
    const newG = Math.round(g + (255 - g) * ratio);
    const newB = Math.round(b + (255 - b) * ratio);
    return `rgb(${newR},${newG},${newB})`;
}

function getColorByDominance(dominance) {
    switch((dominance||"").toLowerCase()) {
        case "indica dominant": return "#6FAC43";
        case "sativa dominant": return "#C89C3E";
        case "balanced hybrid": return "#4391C8";
        default: return "#888";
    }
}

/* ================== DATA FETCH ================== */
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978")
    .then(r => r.ok ? r.text() : Promise.reject("Network error"))
    .then(csvText => {
        const rows = csvText.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
        if (rows.length < 2) return showError("Not enough data in the spreadsheet.");
        attributes = rows[0];
        strainData = rows.slice(1).map(row => {
            let obj = {};
            attributes.forEach((attr,i)=>obj[attr]=row[i]||"");
            return obj;
        }).filter(o=>Object.values(o).some(v=>v!==""));
        document.getElementById("loading-message").style.display="none";
        createLineageChart();
        setupStrainSearch();
    })
    .catch(err => showError("Error fetching data: " + err));


/* ================== CONTRIBUTION CALCULATIONS ================== */
function calculateUpwardChildTotals(startNode, nodes) {
    const contributions = new Map();
    function walk(node, amount) {
        contributions.set(node.id, (contributions.get(node.id)||0)+amount);
        let parents = [];
        if (node.parents) parents = node.parents.map(pid => nodes.find(n=>n.id===pid)).filter(Boolean);
        if (node.variant) { const base = nodes.find(n=>n.name===node.variant); if(base) parents.push(base); }
        if (!parents.length) return;
        const split = amount / parents.length;
        parents.forEach(p=>walk(p,split));
    }
    walk(startNode, 100);
    return contributions;
}

function calculateDownwardDescendantTotals(startNode, nodes) {
    const contributions = new Map();
    function walk(node, amount) {
        if(node.id !== startNode.id) contributions.set(node.id, (contributions.get(node.id)||0)+amount);
        const children = nodes.filter(n=>(n.parents?.includes(node.id))||n.variant===node.name);
        children.forEach(child=>{
            let parentCount = (child.parents?.length||0) + (child.variant?1:0);
            if(!parentCount) return;
            walk(child, amount/parentCount);
        });
    }
    walk(startNode, 100);
    return contributions;
}

/* ================== NODE AND LINK CREATION ================== */
function createLineageChart() {
    const chartContainer = document.querySelector(".chart-container");
    const width = chartContainer.clientWidth;
    const height = chartContainer.clientHeight;
    d3.select("#lineageChart").selectAll("*").remove();
    svg = d3.select("#lineageChart").append("svg").attr("width",width).attr("height",height);
    g = svg.append("g");
    zoom = d3.zoom().scaleExtent([0.1,4]).on("zoom", (event)=>g.attr("transform", event.transform));
    svg.call(zoom);

    // Map spreadsheet data to nodes
    nodes = strainData.map(strain => ({
        id: strain.Strain,
        name: strain.Strain,
        displayName: strain.Strain,
        dominance: strain.Dominance,
        parents: [strain.Parent1,strain.Parent2,strain.Parent3,strain.Parent4].filter(p=>p),
        generation:0,
        special: strain.Special,
        product: strain.Product,
        variant: strain.Variant,
        alsoKnownAs: strain["Also Known As"]
    }));

    const hasChildren = new Set(nodes.flatMap(n=>n.parents));
    nodes = nodes.filter(n=>hasChildren.has(n.name)||n.parents.length>0||n.special||n.variant);

    // assign generations
    assignGenerations();

    // set node positions
    layoutNodes(width, height);

    // generate links
    links = [];
    nodes.forEach(node=>{
        if(node.variant){
            const parentNode = nodes.find(n=>n.name===node.variant);
            if(parentNode) links.push({source: parentNode.id,target: node.id});
        } else {
            node.parents.forEach(p=>{
                if(p && nodes.some(n=>n.id===p)) links.push({source:p,target:node.id});
            });
        }
    });

    drawLinks();
    drawNodes();
}

/* ================== NODE POSITIONING ================== */
function assignGenerations() {
    let changed=true;
    while(changed){
        changed=false;
        nodes.forEach(n=>{
            if(n.special?.toLowerCase()==="origin" && n.generation!==0){ n.generation=0; changed=true; }
            else if(n.special?.toLowerCase()==="landrace" && n.generation!==1){ n.generation=1; changed=true; }
            else if(n.variant){
                const parent = nodes.find(x=>x.name===n.variant);
                if(parent && n.generation!==parent.generation){ n.generation=parent.generation; changed=true; }
            } else {
                const parentGens = n.parents.map(p=>nodes.find(x=>x.id===p)?.generation).filter(x=>x!==undefined);
                if(parentGens.length && n.generation!==Math.max(...parentGens)+1){ n.generation=Math.max(...parentGens)+1; changed=true; }
            }
        });
    }
}

function layoutNodes(width,height){
    const maxGeneration = Math.max(...nodes.map(n=>n.generation));
    const columnWidth = width/(maxGeneration+1);
    const pillHeight = nodePillHeight;

    for(let gen=0;gen<=maxGeneration;gen++){
        let genNodes = nodes.filter(n=>n.generation===gen);
        let yOffset=0;
        const totalHeight = genNodes.length * (pillHeight+10);
        const startY = (height-totalHeight)/2;
        genNodes.forEach(n=>{
            n.x = gen*columnWidth;
            n.y = startY+yOffset;
            yOffset+=pillHeight+10;
        });
    }
}

/* ================== DRAW LINKS ================== */
function drawLinks(){
    g.append("g").selectAll("path")
        .data(links)
        .join("path")
        .attr("class","link")
        .attr("stroke", d=>darkenColor(getColorByDominance(nodes.find(n=>n.id===d.source).dominance),2))
        .attr("stroke-width", lineWidth)
        .attr("fill","none")
        .attr("d", d=>{
            const s=nodes.find(n=>n.id===d.source), t=nodes.find(n=>n.id===d.target);
            return `M${s.x},${s.y} C${(s.x+t.x)/2},${s.y} ${(s.x+t.x)/2},${t.y} ${t.x},${t.y}`;
        });
}

/* ================== DRAW NODES ================== */
function drawNodes(){
    const nodeSelection = g.append("g").selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`)
        .on("click", highlightLineage);

    nodeSelection.append("rect")
        .attr("rx",nodePillHeight/2)
        .attr("ry",nodePillHeight/2)
        .attr("width",d=>d.variant?100*0.85:100)
        .attr("height",nodePillHeight)
        .attr("fill",d=>d.variant?blendToWhite(getColorByDominance(nodes.find(n=>n.name===d.variant)?.dominance||"#888"),0.5):getColorByDominance(d.dominance))
        .attr("stroke",d=>d.product?"black":getColorByDominance(d.dominance))
        .attr("stroke-width",3);

    nodeSelection.append("text")
        .text(d=>d.displayName)
        .attr("x",5).attr("y",1)
        .attr("dominant-baseline","middle")
        .style("font-size","14px")
        .style("font-family","'Roboto', Arial, sans-serif")
        .style("font-weight","bold");
}

/* ================== LINEAGE HIGHLIGHTING ================== */
function highlightLineage(event,d){
    if(focusedNode===d){
        focusedNode=null;
        g.selectAll(".node").classed("dimmed",false);
        g.selectAll(".link").classed("dimmed",false);
        return;
    }
    focusedNode=d;
    const lineage=new Set();
    function getAncestors(n){ lineage.add(n.id); if(n.variant){ const base=nodes.find(x=>x.name===n.variant); if(base){lineage.add(base.id); getAncestors(base);}} n.parents.forEach(pid=>{ const p=nodes.find(x=>x.id===pid); if(p){ lineage.add(p.id); getAncestors(p); }})}
    function getDescendants(id){ lineage.add(id); nodes.filter(n=>n.parents.includes(id)).forEach(c=>getDescendants(c.id)); }
    getAncestors(d); getDescendants(d.id);
    g.selectAll(".node").classed("dimmed", n=>!lineage.has(n.id));
    g.selectAll(".link").classed("dimmed", l=>!lineage.has(l.source)||!lineage.has(l.target));
}

/* ================== SEARCH ================== */
function setupStrainSearch(){
    const input=document.getElementById("strainSearch");
    input.addEventListener("input",()=>{ /* implement dropdown filtering */ });
}
</script>

</body>
</html>

