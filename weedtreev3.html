<!DOCTYPE html>
<html>
<head>
<base href="https://www.weedtree.fyi">

<script src="https://cdn.counter.dev/script.js" data-id="c89e409b-c7ae-4e59-8da1-bf5116b65993" data-utcoffset="13"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-8527SLLPYV"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8527SLLPYV');
</script>

<title>WeedTree Strain Lineage Chart</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v6.min.js"></script>

<style>
/* UNCHANGED STYLES */
body,html{font-family:'Poppins',Arial,sans-serif;background-color:#fff;margin:0;padding:0;font-size:14px;height:100%;overflow:hidden}
.header-ribbon{background-color:#434343;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
.container{height:calc(100vh - 50px);display:flex;flex-direction:column}
.chart-container{flex-grow:1;width:100%;overflow:hidden}
#returnLineageBtn{display:none}
</style>
</head>

<body>
<div class="header-ribbon">
  <h1>WeedTree.fyi Strain Lineage Chart</h1>
  <div>
    <button id="returnLineageBtn">Return to Lineage</button>
  </div>
</div>

<div class="container">
  <div class="chart-container">
    <div id="lineageChart"></div>
  </div>
</div>

<script>
let strainData=[],nodes=[],svg,g,zoom;
let focusedNode=null;
let lastLineageNode=null;
let viewMode="lineage";

fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978')
.then(r=>r.text())
.then(csv=>{
  const rows=csv.trim().split('\n').map(r=>r.split(','));
  const headers=rows.shift();
  strainData=rows.map(r=>{
    const o={};headers.forEach((h,i)=>o[h]=r[i]||'');return o;
  });
  createLineageChart();
});

function baseNodes(){
  return strainData.map(s=>({
    id:s.Strain,
    name:s.Strain,
    parents:[s.Parent1,s.Parent2,s.Parent3,s.Parent4].filter(Boolean),
    dominance:s.Dominance
  }));
}

function createLineageChart(){
  viewMode="lineage";
  document.getElementById('returnLineageBtn').style.display='none';
  nodes=baseNodes();
  draw(nodes,true);
}

function createFamilyTree(root){
  viewMode="family";
  document.getElementById('returnLineageBtn').style.display='inline';
  const map=new Map(nodes.map(n=>[n.id,n]));
  const collected=new Map();

  function walk(n,depth){
    if(!n)return;
    if(!collected.has(n.id) || collected.get(n.id).gen>depth){
      collected.set(n.id,{...n,gen:depth});
    }
    n.parents.forEach(p=>walk(map.get(p),depth+1));
  }
  walk(root,0);

  const fam=[...collected.values()];
  fam.forEach(n=>{
    n.parents=n.parents.filter(p=>collected.has(p))
  });

  draw(fam,false);
}

function draw(data,enableClick){
  d3.select("#lineageChart").selectAll("*").remove();
  const w=document.querySelector('.chart-container').clientWidth;
  const h=document.querySelector('.chart-container').clientHeight;
  svg=d3.select("#lineageChart").append("svg").attr("width",w).attr("height",h);
  g=svg.append("g");
  zoom=d3.zoom().scaleExtent([0.2,4]).on("zoom",e=>g.attr("transform",e.transform));
  svg.call(zoom);

  const levels=d3.group(data,d=>d.gen||0);
  const cols=[...levels.keys()].sort((a,b)=>a-b);
  const colW=w/(cols.length+1);
  const pillW=180,pillH=30;

  cols.forEach((c,i)=>{
    const col=levels.get(c).sort((a,b)=>a.name.localeCompare(b.name));
    col.forEach((n,j)=>{
      n.x=i*colW+colW/2;
      n.y=j*(pillH+10)+h/4;
    });
  });

  const links=[];
  data.forEach(n=>{
    n.parents.forEach(p=>links.push({s:p,t:n.id}));
  });

  g.selectAll("path")
   .data(links).enter()
   .append("path")
   .attr("fill","none")
   .attr("stroke","#999")
   .attr("d",l=>{
     const s=data.find(n=>n.id===l.s);
     const t=data.find(n=>n.id===l.t);
     return `M${s.x},${s.y}C${(s.x+t.x)/2},${s.y} ${(s.x+t.x)/2},${t.y} ${t.x},${t.y}`;
   });

  const node=g.selectAll(".node")
   .data(data).enter()
   .append("g")
   .attr("class","node")
   .attr("transform",d=>`translate(${d.x},${d.y})`)
   .on("click",(e,d)=>{
     if(viewMode==="lineage" && e.shiftKey){
       lastLineageNode=d;
       createFamilyTree(d);
       e.stopPropagation();
     }else if(viewMode==="lineage"){
       focusedNode=d;
     }
   });

  node.append("rect")
   .attr("x",-pillW/2).attr("y",-pillH/2)
   .attr("rx",pillH/2).attr("ry",pillH/2)
   .attr("width",pillW).attr("height",pillH)
   .attr("fill","#bee8a6").attr("stroke","#000");

  node.append("text")
   .attr("x",-pillW/2+10).attr("y",5)
   .text(d=>d.name)
   .style("font-weight","bold");
}

document.getElementById('returnLineageBtn').onclick=()=>{
  if(lastLineageNode){
    createLineageChart();
    setTimeout(()=>{focusedNode=lastLineageNode;},0);
  }
};
</script>
</body>
</html>
