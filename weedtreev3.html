<!DOCTYPE html>
<html>
<head>
<base href="https://www.weedtree.fyi">

<script src="https://cdn.counter.dev/script.js" data-id="c89e409b-c7ae-4e59-8da1-bf5116b65993" data-utcoffset="13"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8527SLLPYV"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8527SLLPYV');
</script>

<title>WeedTree Strain Lineage Chart</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" xhref='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 850"><path fill="%2391C83E" d="M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/><path fill="%236FAC43" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7z"/><path fill="none" stroke="%23444" stroke-width="79.2" stroke-linejoin="round" stroke-miterlimit="8" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7zm-44.8 237.5c137.8 80.2 275.3 80.2 412.7 0M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/></svg>' />
<style>
body,html{font-family:'Poppins',Arial,sans-serif;background-color:#fff;margin:0;padding:0;font-size:14px;height:100%;overflow:hidden}
.header-ribbon{background-color:#434343;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
.header-ribbon h1{margin:0;font-size:1.8em;color:#fff;margin-left:6px}
.subhead{font-size:.4em;font-weight:400;margin-left:3px}
.container{height:calc(100vh - 50px);display:flex;flex-direction:column}
.chart-container{flex-grow:1;width:100%;overflow:hidden}
#lineageChart{width:100%;height:100%}
.header-buttons{display:flex;gap:10px;align-items:center}
.btn{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;cursor:pointer;font-size:0.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btn:hover{background-color:rgba(255,255,255,.1)}
.node text{font-size:16px;fill:black;text-anchor:start;dominant-baseline:middle;font-family:'Roboto',Arial,sans-serif;font-weight:700}
.node text.product{font-size:10px;font-weight:normal;}
.node.dimmed rect,.node.dimmed text,.node.dimmed use,.link.dimmed{opacity:.15}
.node.highlighted rect{stroke:#f0f;stroke-width:3px}
.link.highlighted{stroke:#f0f!important;stroke-width:3px}
.node.clicked rect{stroke:#f0f;stroke-width:8px}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;max-width:80%;max-height:80%;overflow-y:auto;z-index:1000;display:none;}
.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:999;display:none}
#loading-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(255,255,255,0.8);padding:20px;border-radius:10px;z-index:1001;display:none}
#strainSearch{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;font-size:.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;width:180px}
#strainSearch::placeholder{color:rgba(255,255,255,0.7)}
#strainSearch:focus{outline:none;background-color:rgba(255,255,255,0.1)}
#strainDropdown{position:absolute;background-color:#fff;border:1px solid #ccc;max-height:400px;overflow-y:auto;display:none;z-index:1000;width:210px;box-shadow:1 4px 8px rgba(0,0,0,0.1);border-radius:0 0 4px 4px}
#strainDropdown div{padding:5px 10px;cursor:pointer;transition:background-color 0.2s;color:#434343;font-size:8pt;line-height:1.2}
#strainDropdown div:hover{background-color:#f0f0f0}
.search-container{position:relative}
.node.highlighted-search .highlight-arrow{fill:red}
#centerLine{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;}
.fullscreen-button-container{display:flex;flex-direction:column;gap:5px;position:absolute;top:70px;right:10px;z-index:997;}
.zoom-button-container{display:flex;width:100%;gap:5px;}
.fullscreen-button-container button{width:100%;padding:3px 5px;border:2px solid #cccccc;border-radius:0;cursor:pointer;font-size:0.3em;font-family:'Poppins',Arial,sans-serif;transition:all 0.3s ease;color:#cccccc;background-color:white;}
.node{transition: transform 0.0s ease;}
.strain-list{column-width:228px;column-gap:5px;padding:10px;max-height:96%;overflow-x:auto;white-space:nowrap;}
.strain-item{display:flex;align-items:center;margin-bottom:0px;break-inside:avoid-column;}
.strain-checkbox{appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid #434343;border-radius:50%;margin-right:5px;cursor:pointer;position:relative;}
.strain-checkbox:checked::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background-color:#434343;border-radius:50%;}
.strain-checkbox:hover{background-color:#f0f0f0;}
.strain-label{font-size:8pt;cursor:pointer;}
#popup1{padding:0;}
#popup2,#popup3{padding:20px;}
.node use{z-index:1000;pointer-events:none;}
.node text{z-index:999;}
#zoomInButton,#zoomOutButton{flex:1;padding:0px 5px;font-size:16px;font-weight:bold;}
#zoomInButton{border-right:2px solid #cccccc;border-top-right-radius:0;border-bottom-right-radius:0;}
#zoomOutButton{border-left:2px solid #cccccc;border-top-left-radius:0;border-bottom-left-radius:0;}
.close-button{position:absolute;top:10px;right:10px;width:30px;height:30px;border:none;background:#434343;color:white;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color 0.3s;}
.close-button:hover{background-color:#666;}
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
<div class="header-ribbon">
    <h1>WeedTree.fyi Strain Lineage Chart <span class="subhead">Work in progress, errors probable</span></h1>
    <div class="header-buttons">
        <div class="search-container">
            <input type="text" id="strainSearch" placeholder="Locate strain">
            <div id="strainDropdown"></div>
        </div>
        <button id="btn3" class="btn">About</button>
    </div>
</div>

<div class="fullscreen-button-container">
    <button id="fullscreenToggle" class="btn">Toggle Full Screen</button>
    <div class="zoom-button-container">
        <button id="zoomInButton" class="btn">+</button>
        <button id="zoomOutButton" class="btn">-</button>
    </div>
    <button id="deselectButton" class="btn">De-select</button>
</div>

<div class="container">
    <div class="chart-container">
        <div id="lineageChart"></div>
    </div>
</div>

<div class="popup-overlay"></div>
<div id="popup1" class="popup">
    <div id="strainList" class="strain-list"></div>
</div>
<div id="popup2" class="popup"><h5>Record and rate your strains - coming soon</h5></div>
<div id="popup3" class="popup">
    <button class="close-button">Ã—</button>
    <h2>Welcome to Weedtree, the family tree of cannabis strains</h2>
    <p>I've always wondered how strain lineage correlated with the strains I personally prefer...</p>
</div>
<div id="loading-message">Loading strain data, please wait...</div>
<div id="centerLine"></div>

<script>
// Global variables
let strainData = [], attributes = [], nodes = [], links = [];
let svg, g, zoom;
let focusedNode = null;
let showingAncestorTree = false;
const lineWidth = 2;

// Fetch data
const showError = (msg) => { document.getElementById('loading-message').style.display='none'; alert(msg); };
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978')
.then(r=>r.ok?r.text():Promise.reject("Network error"))
.then(csvText=>{
    const rows=csvText.trim().split('\n').map(r=>r.split(',').map(c=>c.trim()));
    if(rows.length<2){showError("Not enough data");return;}
    attributes=rows[0];
    strainData=rows.slice(1).map(r=>{
        let obj={};
        attributes.forEach((a,i)=>obj[a]=r[i]||'');
        return obj;
    }).filter(o=>Object.values(o).some(v=>v!==''));
    document.getElementById('loading-message').style.display='none';
    createLineageChart();
    setupStrainSearch();
})
.catch(e=>showError("Error fetching data: "+e));

// Colors
const getColorByDominance=(d)=>{
    switch(d.toLowerCase()){
        case 'sativa dominant': return '#ffea8a';
        case 'indica dominant': return '#9be7f5';
        case 'ruderalis dominant': return '#d9d2e9';    
        case 'balanced hybrid': return '#bee8a6';
        case 'unknown': return '#d1e6cb';
        default: return '#EAEAEA';
    }
};
const darkenColor=color=>d3.color(color).darker(0.2).toString();

// Create Lineage Chart
function createLineageChart(){
    showingAncestorTree=false;
    const chartContainer = document.querySelector('.chart-container');
    const width=chartContainer.clientWidth, height=chartContainer.clientHeight;
    d3.select("#lineageChart").selectAll("*").remove();
    svg = d3.select("#lineageChart").append("svg").attr("width", width).attr("height", height);
    g = svg.append("g");

    // D3 zoom
    zoom = d3.zoom().scaleExtent([0.1,4]).on("zoom",event=>g.attr("transform",event.transform));
    svg.call(zoom);

    // Nodes
    nodes = strainData.map(strain=>({
        id: strain.Strain,
        name: strain.Strain,
        displayName: strain.Strain,
        dominance: strain.Dominance,
        parents: [strain.Parent1,strain.Parent2,strain.Parent3,strain.Parent4].filter(p=>p),
        generation:0,
        product: strain.Product,
        variant: strain.Variant,
        alsoKnownAs: strain['Also Known As']
    }));

    const hasChildren = new Set(nodes.flatMap(n=>n.parents));
    nodes = nodes.filter(n=>hasChildren.has(n.name)||n.parents.length>0||n.product||n.variant);

    // Links
    links = [];
    nodes.forEach(n=>{
        if(n.variant){
            const p=nodes.find(x=>x.name===n.variant);
            if(p) links.push({source:p.id,target:n.id});
        }else n.parents.forEach(p=>{
            if(p&&nodes.some(x=>x.id===p)) links.push({source:p,target:n.id});
        });
    });

    renderLineageChart();
}

// Render Lineage Chart
function renderLineageChart(){
    const chartContainer=document.querySelector('.chart-container');
    const width=chartContainer.clientWidth, height=chartContainer.clientHeight;
    const pillHeight=30;
    const maxGeneration=Math.max(...nodes.map(n=>n.generation));
    const standardPillWidth=150;
    const columnWidth=width/(maxGeneration+1);

    // Assign x/y positions
    nodes.forEach(n=>{
        n.x=n.generation*columnWidth;
        n.y=Math.random()*(height-pillHeight*2)+pillHeight; // Temporary random vertical spacing
    });

    // Links
    g.selectAll("path.link").data(links).join("path")
        .attr("class","link")
        .attr("stroke",d=>darkenColor(getColorByDominance(nodes.find(n=>n.id===d.source).dominance)))
        .attr("stroke-width",lineWidth)
        .attr("fill","none")
        .attr("d",d=>{
            const s=nodes.find(n=>n.id===d.source), t=nodes.find(n=>n.id===d.target);
            return `M${s.x},${s.y} L${t.x},${t.y}`;
        });

    // Nodes
    const node=g.selectAll("g.node").data(nodes).join("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`)
        .on("click",d=>showAncestorTree(d));

    node.append("rect")
        .attr("rx",pillHeight/2)
        .attr("ry",pillHeight/2)
        .attr("width",standardPillWidth)
        .attr("height",pillHeight)
        .attr("x",-standardPillWidth/2)
        .attr("y",-pillHeight/2)
        .attr("fill",d=>getColorByDominance(d.dominance))
        .attr("stroke",d=>d.product?"black":getColorByDominance(d.dominance))
        .attr("stroke-width",3);

    node.append("text")
        .text(d=>d.displayName)
        .attr("x",-standardPillWidth/2+12)
        .attr("y",1)
        .attr("dominant-baseline","middle")
        .style("font-size","15px")
        .style("font-family","'Roboto',Arial,sans-serif")
        .style("font-weight","700");
}

// Ancestor Tree
function showAncestorTree(node){
    showingAncestorTree=true;
    const ancestors=[];
    const visited=new Set();

    function collectAncestors(n, level){
        if(!n || visited.has(n.id)) return;
        visited.add(n.id);
        n.generation=level;
        ancestors.push(n);
        n.parents.forEach(p=>{
            const parentNode=nodes.find(x=>x.id===p);
            collectAncestors(parentNode,level+1);
        });
    }

    collectAncestors(node,0);

    // Sort each level alphabetically
    ancestors.sort((a,b)=>a.generation-b.generation||a.name.localeCompare(b.name));

    const chartContainer=document.querySelector('.chart-container');
    const width=chartContainer.clientWidth, height=chartContainer.clientHeight;
    const pillHeight=30;
    const standardPillWidth=150;
    const xMargin=50;
    const yMargin=50;

    const maxLevel=Math.max(...ancestors.map(n=>n.generation));
    const nodesByLevel=[];
    for(let i=0;i<=maxLevel;i++) nodesByLevel[i]=ancestors.filter(n=>n.generation===i);

    nodesByLevel.forEach((levelNodes,gen)=>{
        const spacing=(width-2*xMargin)/levelNodes.length;
        levelNodes.forEach((n,i)=>{
            n.x=xMargin+i*spacing+spacing/2-standardPillWidth/2;
            n.y=yMargin+gen*(pillHeight+15);
        });
    });

    d3.select("#lineageChart").selectAll("*").remove();
    svg = d3.select("#lineageChart").append("svg").attr("width", width).attr("height", height);
    g = svg.append("g");

    // Nodes
    const nodeSel=g.selectAll("g.node").data(ancestors).join("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`);

    nodeSel.append("rect")
        .attr("rx",pillHeight/2)
        .attr("ry",pillHeight/2)
        .attr("width",standardPillWidth)
        .attr("height",pillHeight)
        .attr("fill",d=>getColorByDominance(d.dominance))
        .attr("stroke",d=>d.product?"black":getColorByDominance(d.dominance))
        .attr("stroke-width",3);

    nodeSel.append("text")
        .text(d=>d.displayName)
        .attr("x",12)
        .attr("y",1)
        .attr("dominant-baseline","middle")
        .style("font-size","15px")
        .style("font-family","'Roboto',Arial,sans-serif")
        .style("font-weight","700");

    // Show back button
    d3.select("#lineageChart").append("foreignObject")
        .attr("x",20).attr("y",20).attr("width",160).attr("height",40)
        .append("xhtml:button")
        .text("Show as Lineage Chart")
        .style("font-size","12px")
        .style("padding","6px 12px")
        .on("click",()=>createLineageChart());
}

// Strain search (basic)
function setupStrainSearch(){
    const input=document.getElementById('strainSearch');
    const dropdown=document.getElementById('strainDropdown');
    input.addEventListener('input',()=>{
        const val=input.value.toLowerCase();
        dropdown.innerHTML='';
        if(val.length>0){
            strainData.filter(s=>s.Strain.toLowerCase().includes(val)).forEach(s=>{
                const div=document.createElement('div');
                div.textContent=s.Strain;
                div.onclick=()=>{input.value=s.Strain; dropdown.style.display='none';};
                dropdown.appendChild(div);
            });
            dropdown.style.display='block';
        }else dropdown.style.display='none';
    });
    document.addEventListener('click',e=>{
        if(!input.contains(e.target)) dropdown.style.display='none';
    });
}
</script>
</body>
</html>
