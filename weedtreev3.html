<!DOCTYPE html>
<html>
<head>
<base href="https://www.weedtree.fyi">

<script src="https://cdn.counter.dev/script.js" data-id="c89e409b-c7ae-4e59-8da1-bf5116b65993" data-utcoffset="13"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8527SLLPYV"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8527SLLPYV');
</script>

<title>WeedTree Strain Lineage Chart</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" xhref='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 850"><path fill="%2391C83E" d="M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/><path fill="%236FAC43" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7z"/><path fill="none" stroke="%23444" stroke-width="79.2" stroke-linejoin="round" stroke-miterlimit="8" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7zm-44.8 237.5c137.8 80.2 275.3 80.2 412.7 0M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/></svg>' />
<style>
/* --- Basic layout & header --- */
body,html{font-family:'Poppins',Arial,sans-serif;background-color:#fff;margin:0;padding:0;font-size:14px;height:100%;overflow:hidden}
.header-ribbon{background-color:#434343;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
.header-ribbon h1{margin:0;font-size:1.8em;color:#fff;margin-left:6px}
.subhead{font-size:.4em;font-weight:400;margin-left:3px}
.container{height:calc(100vh - 50px);display:flex;flex-direction:column}
.chart-container{flex-grow:1;width:100%;overflow:hidden}
#lineageChart{width:100%;height:100%}
.header-buttons{display:flex;gap:10px;align-items:center}
.btn{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;cursor:pointer;font-size:0.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btn:hover{background-color:rgba(255,255,255,.1)}
.node text{font-size:16px;fill:black;text-anchor:start;dominant-baseline:middle;font-family:'Roboto',Arial,sans-serif;font-weight:700}
.node text.product{font-size:10px;font-weight:normal;}
.node.dimmed rect{opacity:.15}.node.dimmed text{opacity:.15}.node.dimmed use{opacity:.15}.link.dimmed{opacity:.15}.node.highlighted rect{stroke:#f0f;stroke-width:3px}.link.highlighted{stroke:#f0f!important;stroke-width:3px}.node.clicked rect{stroke:#f0f;stroke-width:8px}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;max-width:80%;max-height:80%;overflow-y:auto;z-index:1000;display:none;}
.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:999;display:none}
#loading-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(255,255,255,0.8);padding:20px;border-radius:10px;z-index:1001;display:none}
#strainSearch{background-color:transparent;color:#fff;padding:5px 15px;border:2px solid #fff;border-radius:18px;font-size:.9em;font-family:'Poppins',Arial,sans-serif;transition:all .3s ease;width:180px}
#strainSearch::placeholder{color:rgba(255,255,255,0.7)}
#strainSearch:focus{outline:none;background-color:rgba(255,255,255,0.1)}
#strainDropdown{position:absolute;background-color:#fff;border:1px solid #ccc;max-height:400px;overflow-y:auto;display:none;z-index:1000;width:210px;box-shadow:1 4px 8px rgba(0,0,0,0.1);border-radius:0 0 4px 4px}
#strainDropdown div{padding:5px 10px;cursor:pointer;transition:background-color 0.2s;color:#434343;font-size:8pt;line-height:1.2}
#strainDropdown div:hover{background-color:#f0f0f0}
.search-container{position:relative}
.node.highlighted-search .highlight-arrow{fill:red}
#centerLine {position: fixed;top: 0;left: 0;width: 100%;height: 100%;pointer-events: none;}
.fullscreen-button-container {display: flex;flex-direction: column;gap: 5px;position: absolute;top: 70px;right: 10px;z-index: 997;}
.zoom-button-container {display: flex;width: 100%;gap: 5px;}
.fullscreen-button-container button {width: 100%;padding: 3px 5px;border: 2px solid #cccccc;border-radius: 0;cursor: pointer;font-size: 0.3em;font-family: 'Poppins', Arial, sans-serif;transition: all 0.3s ease;color: #cccccc;background-color: white;}
.node{transition: transform 0.0s ease;}
.strain-list {column-width: 228px;column-gap: 5px;padding: 10px;max-height: 96%;overflow-x: auto;white-space: nowrap;}
.strain-item {display: flex;align-items: center;margin-bottom: 0px;break-inside: avoid-column;}
.strain-checkbox {appearance: none;-webkit-appearance: none;width: 16px;height: 16px;border: 2px solid #434343;border-radius: 50%;margin-right: 5px;cursor: pointer;position: relative;}
.strain-checkbox:checked::after {content: '';position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);width: 10px;height: 10px;background-color:#434343;border-radius:50%;}
.strain-checkbox:hover {background-color: #f0f0f0;}
.strain-label {font-size: 8pt;cursor: pointer;}
#popup1 {padding: 0;}#popup2, #popup3 {padding: 20px;}
.node use {z-index: 1000; pointer-events: none;} 
.node text {z-index: 999;}
#zoomInButton, #zoomOutButton {flex: 1;padding: 0px 5px;font-size: 16px;font-weight: bold;}
#zoomInButton {border-right: 2px solid #cccccc; border-top-right-radius: 0;border-bottom-right-radius: 0;}
#zoomOutButton {border-left: 2px solid #cccccc; border-top-left-radius: 0;border-bottom-left-radius: 0;}
.close-button {position: absolute;top: 10px;right: 10px;width: 30px;height: 30px;border:none;background:#434343;color:white;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color 0.3s;}
.close-button:hover {background-color:#666;}
#switchBackButton {position:absolute;top:70px;right:10px;z-index:998;display:none;}
</style>
<script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<div class="header-ribbon">
    <h1>WeedTree.fyi Strain Lineage Chart <span class="subhead">Work in progress, errors probable</span></h1>
    <div class="header-buttons">
        <div class="search-container">
            <input type="text" id="strainSearch" placeholder="Locate strain">
            <div id="strainDropdown"></div>
        </div>
        
        <button id="btn3" class="btn">About</button>
    </div>
</div>

<button id="switchBackButton" class="btn">Show as Lineage Chart</button>

<div class="fullscreen-button-container">
    <button id="fullscreenToggle" class="btn">Toggle Full Screen</button>
    <div class="zoom-button-container">
        <button id="zoomInButton" class="btn">+</button>
        <button id="zoomOutButton" class="btn">-</button>
    </div>
    <button id="deselectButton" class="btn">De-select</button>
</div>
<div class="container">
    <div class="chart-container">
        <div id="lineageChart"></div>
    </div>
</div>
<div class="popup-overlay"></div>
<div id="popup1" class="popup">
    <div id="strainList" class="strain-list"></div>
</div>
<div id="popup2" class="popup"><h5>Record and rate your strains - coming soon</h5></div>
<div id="popup3" class="popup">
    <button class="close-button">Ã—</button>
    <h2>Welcome to Weedtree, the family tree of cannabis strains</h2>
    <p>I've always wondered how strain lineage correlated with the strains I personally prefer. Indica vs Sativa, Kush vs Afghani, Skunk vs Thai. I haven't been able to find much of a lineage chart anywhere online so decided to create one myself. </p>
    <p>I don't claim that the chart is completely accurate, it is based on what I could interpret from the multitude of, often contradictory, strain database sites internationally, and I've made some simplifications around phenotype/cultivar/clone/variant pedigree. Obviously it is far from complete.</p>
    <p></br>Push F11 to toggle full screen.</br>Use the mouse or controls to zoom in and out.</br> Click on a strain to isolate its lineage.</p>
</div>
<div id="loading-message">Loading strain data, please wait...</div>
<div id="centerLine"></div>
<svg id="nzIconTemplate" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="display: none;">
  <symbol id="nzIcon">
    <circle cx="14" cy="14" r="12.5" fill="white" stroke="black" stroke-width="3"/>
    <line x1="7" y1="9" x2="7" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="7" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="13" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="9" x2="20.5" y2="9" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="19" x2="21.5" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="21.5" y1="9" x2="16" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
  </symbol>
</svg>

<script>
let strainData = [], attributes = [], nodes = [], svg, g, zoom, focusedNode = null, lineWidth = 2;

// ---- Fetch Data ----
const showError = (message) => {
    document.getElementById('loading-message').style.display = 'none';
    alert(message);
};
    
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978')
    .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
    })
    .then(csvText => {
        const rows = csvText.trim().split('\n').map(row => row.split(',').map(cell => cell.trim()));
        if (rows.length < 2) { showError("Not enough data."); return; }
        attributes = rows[0];
        strainData = rows.slice(1).map(row => {
            let obj = {};
            attributes.forEach((attr,i)=>obj[attr]=row[i]||'');
            return obj;
        }).filter(obj => Object.values(obj).some(v=>v!==''));
        document.getElementById('loading-message').style.display = 'none';
        createLineageChart();
        setupStrainSearch();
    })
    .catch(error => { showError("Error fetching data: "+error.message); console.error(error); });

// ---- Colors ----
const getColorByDominance = (d)=>{switch(d.toLowerCase()){case 'sativa dominant':return '#ffea8a';case 'indica dominant':return '#9be7f5';case 'ruderalis dominant':return '#d9d2e9';case 'balanced hybrid':return '#bee8a6';case 'unknown':return '#d1e6cb';default:return '#EAEAEA';}};
const darkenColor = (c,a)=>d3.color(c).darker(a/10).toString();
const blendToWhite = (c,a)=>d3.interpolateRgb(d3.color(c), d3.color('#fff'))(a);

// ---- Lineage Chart ----
function createLineageChart(){
    const chartContainer=document.querySelector('.chart-container');
    const width=chartContainer.clientWidth,height=chartContainer.clientHeight;
    d3.select("#lineageChart").selectAll("*").remove();
    svg=d3.select("#lineageChart").append("svg").attr("width",width).attr("height",height);
    g=svg.append("g");
    zoom=d3.zoom().scaleExtent([0.1,4]).on("zoom",event=>g.attr("transform",event.transform));
    svg.call(zoom);

    // Nodes
    nodes=strainData.map(s=>({id:s.Strain,name:s.Strain,displayName:s.Strain,dominance:s.Dominance,parents:[s.Parent1,s.Parent2,s.Parent3,s.Parent4].filter(p=>p),generation:0,special:s.Special,
    })));
    
    // Layout: simple vertical stacking by generation (basic version, can be improved)
    const simulation = d3.forceSimulation(nodes)
        .force("x", d3.forceX((d,i)=>width/2).strength(0.1))
        .force("y", d3.forceY((d,i)=>i*40+40).strength(0.1))
        .force("collide", d3.forceCollide(25))
        .stop();
    
    for(let i=0;i<120;++i) simulation.tick();

    // Draw nodes
    const node = g.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`)
        .on("click",(event,d)=>showAncestorTree(d));

    node.append("rect")
        .attr("x",-50)
        .attr("y",-15)
        .attr("width",100)
        .attr("height",30)
        .attr("rx",15)
        .attr("ry",15)
        .attr("fill",d=>getColorByDominance(d.dominance))
        .attr("stroke","#434343")
        .attr("stroke-width",2);

    node.append("text")
        .text(d=>d.displayName)
        .attr("dy", "0.35em")
        .attr("x",0)
        .attr("text-anchor","middle")
        .style("font-family","Roboto")
        .style("font-weight","700")
        .style("pointer-events","none");

    focusedNode = null;
}

// ---- Ancestor Tree View ----
function showAncestorTree(strainNode){
    document.getElementById("switchBackButton").style.display = "block";
    d3.select("#lineageChart").selectAll("*").remove();
    
    const width = document.querySelector('.chart-container').clientWidth;
    const nodes = [];
    const levelMap = {}; // generation level -> array of nodes

    // Recursive function to add ancestors
    function addAncestors(node, level){
        if(!levelMap[level]) levelMap[level]=[];
        if(levelMap[level].some(n=>n.id===node.id)) return; // avoid duplicates
        levelMap[level].push(node);

        const parentNames = [node.parents?.[0], node.parents?.[1], node.parents?.[2], node.parents?.[3]].filter(p=>p);
        parentNames.forEach(pName=>{
            const parentNode = strainData.find(s=>s.Strain===pName);
            if(parentNode){
                const newNode = {id:parentNode.Strain, displayName:parentNode.Strain, dominance:parentNode.Dominance, parents:[parentNode.Parent1,parentNode.Parent2,parentNode.Parent3,parentNode.Parent4].filter(x=>x)};
                addAncestors(newNode, level+1);
            }
        });
    }

    const rootNode = {id:strainNode.id, displayName:strainNode.displayName, dominance:strainNode.dominance, parents:strainNode.parents};
    addAncestors(rootNode,0);

    const svg = d3.select("#lineageChart").append("svg")
        .attr("width", width)
        .attr("height", 600);
    const g = svg.append("g");

    // Layout nodes top-down
    const nodeSizeX = 120;
    const nodeSizeY = 50;
    const levelKeys = Object.keys(levelMap).sort((a,b)=>a-b);

    levelKeys.forEach((lvl,li)=>{
        const row = levelMap[lvl];
        row.sort((a,b)=>a.displayName.localeCompare(b.displayName));
        row.forEach((n,ni)=>{
            n.x = ni*nodeSizeX + 60; // horizontal spacing
            n.y = li*nodeSizeY + 40; // vertical spacing
        });
    });

    const allNodes = [].concat(...Object.values(levelMap));
    const node = g.selectAll(".node")
        .data(allNodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`);

    node.append("rect")
        .attr("x",-50)
        .attr("y",-15)
        .attr("width",100)
        .attr("height",30)
        .attr("rx",15)
        .attr("ry",15)
        .attr("fill",d=>getColorByDominance(d.dominance))
        .attr("stroke","#434343")
        .attr("stroke-width",2);

    node.append("text")
        .text(d=>d.displayName)
        .attr("dy", "0.35em")
        .attr("x",0)
        .attr("text-anchor","middle")
        .style("font-family","Roboto")
        .style("font-weight","700")
        .style("pointer-events","none");
}

// ---- Switch back to Lineage Chart ----
document.getElementById("switchBackButton").addEventListener("click",()=>{
    document.getElementById("switchBackButton").style.display = "none";
    createLineageChart();
});

// ---- Search ----
function setupStrainSearch(){
    const searchInput = document.getElementById("strainSearch");
    const dropdown = document.getElementById("strainDropdown");

    searchInput.addEventListener("input",()=>{
        const value = searchInput.value.toLowerCase();
        dropdown.innerHTML = "";
        if(!value) return dropdown.style.display="none";
        const matches = strainData.filter(s=>s.Strain.toLowerCase().includes(value));
        matches.slice(0,10).forEach(s=>{
            const div = document.createElement("div");
            div.textContent = s.Strain;
            div.addEventListener("click",()=>{searchInput.value=""; dropdown.style.display="none"; showAncestorTree(s);});
            dropdown.appendChild(div);
        });
        dropdown.style.display = matches.length>0?"block":"none";
    });

    document.addEventListener("click", e=>{if(!e.target.closest(".search-container")) dropdown.style.display="none";});
}

// ---- Popup close button ----
document.querySelectorAll(".popup .close-button").forEach(btn=>{
    btn.addEventListener("click",()=>{btn.parentElement.style.display="none"; document.querySelector(".popup-overlay").style.display="none";});
});
</script>
</body>
</html>
