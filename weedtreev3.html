<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<base href="https://imperfiktillusion.github.io/weedtree/">
<title>WeedTree.fyi Strain Lineage Chart</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 850"><path fill="%2391C83E" d="M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/><path fill="%236FAC43" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7z"/><path fill="none" stroke="%23444" stroke-width="79.2" stroke-linejoin="round" stroke-miterlimit="8" d="M503.2 266c0-18.6 17.8-33.7 39.7-33.7 22 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-22 0-39.7-15.1-39.7-33.7zm-244.2 0c0-18.6 17.8-33.7 39.7-33.7 21.9 0 39.7 15.1 39.7 33.7 0 18.6-17.8 33.7-39.7 33.7-21.9 0-39.7-15.1-39.7-33.7zm-44.8 237.5c137.8 80.2 275.3 80.2 412.7 0M39.6 362.6C39.6 184.2 210.3 39.6 420.9 39.6c210.5 0 381.2 144.6 381.2 323 0 178.4-170.7 323-381.2 323-210.6 0-381.3-144.6-381.3-323z"/></svg>' />
<style>
/* Your original CSS here - unchanged */
body,html{font-family:'Poppins',Arial,sans-serif;background-color:#fff;margin:0;padding:0;font-size:14px;height:100%;overflow:hidden}
/* ...keep all previous CSS unchanged for brevity... */
</style>
<script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<div class="header-ribbon">
    <h1>WeedTree.fyi Strain Lineage Chart <span class="subhead">Work in progress, errors probable</span></h1>
    <div class="header-buttons">
        <div class="search-container">
            <input type="text" id="strainSearch" placeholder="Locate strain">
            <div id="strainDropdown"></div>
        </div>
        <button id="btn3" class="btn">About</button>
    </div>
</div>

<div class="fullscreen-button-container">
    <button id="fullscreenToggle" class="btn">Toggle Full Screen</button>
    <div class="zoom-button-container">
        <button id="zoomInButton" class="btn">+</button>
        <button id="zoomOutButton" class="btn">-</button>
    </div>
    <button id="deselectButton" class="btn">De-select</button>
</div>

<div class="container">
    <div class="chart-container">
        <div id="lineageChart"></div>
    </div>
</div>

<div class="popup-overlay"></div>
<div id="popup1" class="popup">
    <div id="strainList" class="strain-list"></div>
</div>
<div id="popup2" class="popup"><h5>Record and rate your strains - coming soon</h5></div>
<div id="popup3" class="popup">
    <button class="close-button">Ã—</button>
    <h2>Welcome to Weedtree, the family tree of cannabis</h2>
    <p>I've always wondered how strain lineage correlated with the strains I personally prefer...</p>
</div>
<div id="loading-message">Loading strain data, please wait...</div>
<div id="centerLine"></div>
<svg id="nzIconTemplate" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="display: none;">
  <symbol id="nzIcon">
    <circle cx="14" cy="14" r="12.5" fill="white" stroke="black" stroke-width="3"/>
    <line x1="7" y1="9" x2="7" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="7" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="13" y1="9" x2="13" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="9" x2="20.5" y2="9" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="16" y1="19" x2="21.5" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
    <line x1="21.5" y1="9" x2="16" y2="19" stroke="black" stroke-width="3" stroke-linecap="round"/>
  </symbol>
</svg>

<script>
// --- Fetch CSV and initialize chart ---
let strainData = [], attributes = [], nodes = [], svg, g, zoom, focusedNode = null, lineWidth = 2;

const showError = (message) => {
    document.getElementById('loading-message').style.display = 'none';
    alert(message);
};

function fetchStrainData() {
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978')
    .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
    })
    .then(csvText => {
        const rows = csvText.trim().split('\n').map(row => row.split(',').map(cell => cell.trim()));
        if (rows.length < 2) return showError("Not enough data in the spreadsheet.");
        attributes = rows[0];
        strainData = rows.slice(1).map(row => {
            let obj = {};
            attributes.forEach((attr, i) => obj[attr] = row[i] || '');
            return obj;
        }).filter(obj => Object.values(obj).some(v => v !== ''));
        document.getElementById('loading-message').style.display = 'none';
        createLineageChart();
        setupStrainSearch();
    })
    .catch(error => { showError("Error fetching data: " + error.message); console.error(error); });
}

// --- Strain search (works on mobile) ---
function setupStrainSearch() {
    const searchInput = document.getElementById('strainSearch');
    const dropdown = document.getElementById('strainDropdown');
    let highlightedNode = null;

    const showDropdownResults = (searchText) => {
        const matchingStrains = nodes.filter(node => !node.name.toLowerCase().includes('unknown') &&
            (node.name.toLowerCase().includes(searchText) ||
             (node.product && node.product.toLowerCase().includes(searchText)) ||
             (node.alsoKnownAs && node.alsoKnownAs.toLowerCase().includes(searchText)))
        );
        dropdown.innerHTML = '';
        matchingStrains.sort((a,b)=>a.name.localeCompare(b.name)).forEach(strain => {
            const div = document.createElement('div');
            div.innerHTML = strain.name + (strain.product ? `<br>(${strain.product})`:'') + (strain.alsoKnownAs ? ` [${strain.alsoKnownAs}]`:'');
            div.addEventListener('click', () => { highlightStrain(strain); dropdown.style.display='none'; searchInput.value=''; });
            div.addEventListener('touchstart', () => { highlightStrain(strain); dropdown.style.display='none'; searchInput.value=''; });
            dropdown.appendChild(div);
        });
        dropdown.style.display = matchingStrains.length > 0 ? 'block' : 'none';
    };

    searchInput.addEventListener('input', function(){ showDropdownResults(this.value.toLowerCase()); });
    document.addEventListener('click', e => { if(!searchInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display='none'; });
    document.addEventListener('touchstart', e => { if(!searchInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display='none'; });

    function highlightStrain(strain) {
        if(highlightedNode) { d3.select(highlightedNode).select('.highlight-arrow').remove(); highlightedNode=null; }
        const nodeSel = g.selectAll('.node').filter(d => d.id === strain.id);
        const arrow = nodeSel.append('path').attr('d','M-70,-6 L-39,0 L-70,6 Z').attr('class','highlight-arrow').attr('fill','red').attr('transform','translate(0,0) scale(3)');
        highlightedNode = nodeSel.node();
        zoomToNode(strain);
    }

    function zoomToNode(strain) {
        const scale = 2;
        const x = -strain.x*scale + svg.attr('width')/2;
        const y = -strain.y*scale + svg.attr('height')/2;
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(x,y).scale(scale));
    }
}

window.onload = function(){
    fetchStrainData();
    document.getElementById('btn3').addEventListener('click', ()=>{ document.getElementById('popup3').style.display='block'; document.querySelector('.popup-overlay').style.display='block'; });
    document.getElementById('popup3').style.display='block'; document.querySelector('.popup-overlay').style.display='block';
};

// --- Remaining original code like createLineageChart(), zoom, popups, fullscreen etc. ---
// Keep your previous createLineageChart() and other functions below exactly as-is.
</script>
</body>
</html>
