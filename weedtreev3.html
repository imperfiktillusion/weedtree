<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cannabis Strain Lineage</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    body { font-family: Roboto, sans-serif; }
    .chart-container { width: 100%; height: 600px; position: relative; }
    .search-container { position: relative; margin-bottom: 10px; }
    #strainDropdown { 
        position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; display: none; max-height: 200px; overflow-y: auto; z-index: 10;
    }
    #strainDropdown div { padding: 5px; cursor: pointer; }
    #strainDropdown div:hover { background: #f0f0f0; }
    #switchBackButton { display: none; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="search-container">
    <input type="text" id="strainSearch" placeholder="Search strain...">
    <div id="strainDropdown"></div>
</div>
<button id="switchBackButton">Show as Lineage Chart</button>
<div class="chart-container" id="lineageChart"></div>

<script>
// Sample data
const strainData = [
    { Strain: "OG Kush", Dominance: "Indica", Parent1:"Hindu Kush", Parent2:"Chemdawg" },
    { Strain: "Hindu Kush", Dominance: "Indica" },
    { Strain: "Chemdawg", Dominance: "Hybrid" },
    { Strain: "Blue Dream", Dominance: "Sativa", Parent1:"Blueberry", Parent2:"Haze" },
    { Strain: "Blueberry", Dominance: "Indica" },
    { Strain: "Haze", Dominance: "Sativa" }
];

function getColorByDominance(d){
    if(d==="Indica") return "#6f42c1";
    if(d==="Sativa") return "#e83e8c";
    return "#20c997";
}

let focusedNode = null;

function createLineageChart(){
    const container = d3.select("#lineageChart");
    container.selectAll("*").remove();
    const width = container.node().clientWidth;
    const height = 600;

    const svg = container.append("svg").attr("width", width).attr("height", height);
    const g = svg.append("g");

    // Prepare nodes
    const nodes = strainData.map(d=>({
        id:d.Strain,
        displayName:d.Strain,
        dominance:d.Dominance,
        parents:[d.Parent1,d.Parent2,d.Parent3,d.Parent4].filter(p=>p)
    }));

    const simulation = d3.forceSimulation(nodes)
        .force("x", d3.forceX(width/2).strength(0.05))
        .force("y", d3.forceY(height/2).strength(0.05))
        .force("collide", d3.forceCollide(50))
        .stop();

    for(let i=0;i<200;++i) simulation.tick();

    const node = g.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform", d=>`translate(${d.x},${d.y})`)
        .on("click", (event,d)=> showAncestorTree(d));

    node.append("rect")
        .attr("x",-50)
        .attr("y",-15)
        .attr("width",100)
        .attr("height",30)
        .attr("rx",15)
        .attr("ry",15)
        .attr("fill", d=>getColorByDominance(d.dominance))
        .attr("stroke","#434343")
        .attr("stroke-width",2);

    node.append("text")
        .text(d=>d.displayName)
        .attr("x",0)
        .attr("text-anchor","middle")
        .attr("dy","0.35em")
        .style("pointer-events","none")
        .style("font-family","Roboto")
        .style("font-weight","700");
}

// Ancestor tree view
function showAncestorTree(strainNode){
    document.getElementById("switchBackButton").style.display = "block";
    const container = d3.select("#lineageChart");
    container.selectAll("*").remove();
    const width = container.node().clientWidth;

    const nodes = [];
    const levelMap = {};

    function addAncestors(node, level){
        if(!levelMap[level]) levelMap[level] = [];
        if(levelMap[level].some(n=>n.id===node.id)) return;
        levelMap[level].push(node);

        (node.parents||[]).forEach(pName=>{
            const parentNode = strainData.find(s=>s.Strain===pName);
            if(parentNode){
                const newNode = {id: parentNode.Strain, displayName: parentNode.Strain, dominance: parentNode.Dominance, parents:[parentNode.Parent1,parentNode.Parent2,parentNode.Parent3,parentNode.Parent4].filter(x=>x)};
                addAncestors(newNode, level+1);
            }
        });
    }

    const rootNode = {id:strainNode.id, displayName:strainNode.displayName, dominance:strainNode.dominance, parents:strainNode.parents};
    addAncestors(rootNode,0);

    const svg = container.append("svg").attr("width", width).attr("height", 600);
    const g = svg.append("g");

    const nodeSizeX = 120;
    const nodeSizeY = 50;
    const levelKeys = Object.keys(levelMap).sort((a,b)=>a-b);

    levelKeys.forEach((lvl,li)=>{
        const row = levelMap[lvl];
        row.sort((a,b)=>a.displayName.localeCompare(b.displayName));
        row.forEach((n,ni)=>{
            n.x = ni*nodeSizeX + 60;
            n.y = li*nodeSizeY + 40;
        });
    });

    const allNodes = [].concat(...Object.values(levelMap));
    const node = g.selectAll(".node")
        .data(allNodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform", d=>`translate(${d.x},${d.y})`);

    node.append("rect")
        .attr("x",-50)
        .attr("y",-15)
        .attr("width",100)
        .attr("height",30)
        .attr("rx",15)
        .attr("ry",15)
        .attr("fill", d=>getColorByDominance(d.dominance))
        .attr("stroke","#434343")
        .attr("stroke-width",2);

    node.append("text")
        .text(d=>d.displayName)
        .attr("x",0)
        .attr("text-anchor","middle")
        .attr("dy","0.35em")
        .style("pointer-events","none")
        .style("font-family","Roboto")
        .style("font-weight","700");
}

// Switch back
document.getElementById("switchBackButton").addEventListener("click",()=>{
    document.getElementById("switchBackButton").style.display = "none";
    createLineageChart();
});

// Search
function setupStrainSearch(){
    const searchInput = document.getElementById("strainSearch");
    const dropdown = document.getElementById("strainDropdown");
    searchInput.addEventListener("input", ()=>{
        const val = searchInput.value.toLowerCase();
        dropdown.innerHTML = "";
        if(!val) return dropdown.style.display="none";
        const matches = strainData.filter(s=>s.Strain.toLowerCase().includes(val));
        matches.slice(0,10).forEach(s=>{
            const div = document.createElement("div");
            div.textContent = s.Strain;
            div.addEventListener("click", ()=>{
                searchInput.value = "";
                dropdown.style.display = "none";
                showAncestorTree(s);
            });
            dropdown.appendChild(div);
        });
        dropdown.style.display = matches.length>0?"block":"none";
    });
    document.addEventListener("click", e=>{if(!e.target.closest(".search-container")) dropdown.style.display="none";});
}

// Init
createLineageChart();
setupStrainSearch();
</script>
</body>
</html>
