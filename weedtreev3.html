<!DOCTYPE html>
<html lang="en">
<head>
<base href="https://www.weedtree.fyi">

<script src="https://cdn.counter.dev/script.js" data-id="c89e409b-c7ae-4e59-8da1-bf5116b65993" data-utcoffset="13"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-8527SLLPYV"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8527SLLPYV');
</script>

<title>WeedTree Strain Lineage Chart</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v6.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  font-family:'Poppins',sans-serif;
  overflow:hidden;
}
.header{
  height:48px;
  background:#3f3f3f;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
}
#chart{
  width:100%;
  height:calc(100% - 48px);
}
button{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.node rect{
  rx:16;
  ry:16;
  stroke:#222;
  stroke-width:1;
}
.node text{
  font-size:12px;
  pointer-events:none;
  fill:#000;
}
.link{
  fill:none;
  stroke:#999;
  stroke-width:1.2;
}
</style>
</head>

<body>
<div class="header">
  <div>WeedTree.fyi</div>
  <button id="returnBtn" style="display:none">Return to Lineage</button>
</div>
<div id="chart"></div>

<script>
let rawData=[];
let allNodes=[];
let svg,g,zoom;
let currentMode="lineage";
let lastLineageFocus=null;

fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSoTjN6psMidKhKOaAxqcZQQ_ArKkUTuRgn65c3ncNqjdLASER0J-Z3WYxFNuhFX_gDVoyHyH1PcCZy/pub?output=csv&gid=1070299978")
.then(r=>r.text())
.then(t=>{
  const rows=t.trim().split("\n").map(r=>r.split(","));
  const headers=rows.shift();
  rawData=rows.map(r=>{
    const o={};
    headers.forEach((h,i)=>o[h]=r[i]||"");
    return o;
  });
  init();
});

function init(){
  allNodes=rawData.map(d=>({
    id:d.Strain,
    name:d.Strain,
    parents:[d.Parent1,d.Parent2,d.Parent3,d.Parent4].filter(Boolean)
  }));
  renderLineage();
}

function renderLineage(){
  currentMode="lineage";
  document.getElementById("returnBtn").style.display="none";
  const nodes=allNodes.map(n=>({...n}));
  computeGenerations(nodes);
  draw(nodes,true);
}

function renderFamily(root){
  currentMode="family";
  document.getElementById("returnBtn").style.display="inline";

  const map=new Map(allNodes.map(n=>[n.id,n]));
  const out=new Map();

  function walk(node,gen){
    if(!node) return;
    if(!out.has(node.id) || out.get(node.id).gen>gen){
      out.set(node.id,{...node,gen});
    }
    node.parents.forEach(p=>walk(map.get(p),gen+1));
  }

  walk(root,0);

  const nodes=[...out.values()];
  nodes.forEach(n=>{
    n.parents=n.parents.filter(p=>out.has(p));
  });

  draw(nodes,false);
}

function computeGenerations(nodes){
  const map=new Map(nodes.map(n=>[n.id,n]));
  function gen(n){
    if(n._g!==undefined) return n._g;
    if(!n.parents.length) return n._g=0;
    return n._g=1+Math.max(...n.parents.map(p=>map.get(p)?gen(map.get(p)):0));
  }
  nodes.forEach(n=>n.gen=gen(n));
}

function draw(nodes,allowClick){
  d3.select("#chart").selectAll("*").remove();
  const w=document.getElementById("chart").clientWidth;
  const h=document.getElementById("chart").clientHeight;

  svg=d3.select("#chart").append("svg").attr("width",w).attr("height",h);
  g=svg.append("g");

  zoom=d3.zoom().scaleExtent([0.25,4]).on("zoom",e=>g.attr("transform",e.transform));
  svg.call(zoom);

  const levels=d3.group(nodes,d=>d.gen);
  const gens=[...levels.keys()].sort((a,b)=>a-b);

  const colW=w/(gens.length+1);
  const nodeW=170,nodeH=28;

  gens.forEach((gIdx,i)=>{
    const col=levels.get(gIdx).sort((a,b)=>a.name.localeCompare(b.name));
    col.forEach((n,j)=>{
      n.x=(i+1)*colW;
      n.y=60+j*(nodeH+10);
    });
  });

  const links=[];
  nodes.forEach(n=>{
    n.parents.forEach(p=>{
      const s=nodes.find(x=>x.id===p);
      if(s) links.push({s,t:n});
    });
  });

  g.selectAll(".link")
   .data(links)
   .enter()
   .append("path")
   .attr("class","link")
   .attr("d",d=>{
     const mx=(d.s.x+d.t.x)/2;
     return `M${d.s.x},${d.s.y} C${mx},${d.s.y} ${mx},${d.t.y} ${d.t.x},${d.t.y}`;
   });

  const node=g.selectAll(".node")
   .data(nodes)
   .enter()
   .append("g")
   .attr("class","node")
   .attr("transform",d=>`translate(${d.x},${d.y})`)
   .on("click",(e,d)=>{
     if(currentMode==="lineage" && e.shiftKey){
       lastLineageFocus=d;
       renderFamily(d);
       e.stopPropagation();
     }
   });

  node.append("rect")
   .attr("x",-nodeW/2)
   .attr("y",-nodeH/2)
   .attr("width",nodeW)
   .attr("height",nodeH)
   .attr("fill","#c6efb5");

  node.append("text")
   .attr("text-anchor","middle")
   .attr("dy","0.35em")
   .text(d=>d.name);
}

document.getElementById("returnBtn").onclick=()=>{
  if(lastLineageFocus){
    renderLineage();
  }
};
</script>
</body>
</html>
